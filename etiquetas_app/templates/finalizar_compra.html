{% extends 'base.html' %}
{% block title %}Finalizar Compra{% endblock %}
{% block content %}
<div class="container">
    <h2 class="mb-4">Finalizar Compra</h2>
    
    <form method="POST" class="needs-validation" novalidate>
        <div class="row g-4">
            <!-- Columna Izquierda -->
            <div class="col-md-6">
                <!-- Nombre completo -->
                <div class="mb-3">
                    <label class="form-label">Nombre completo</label>
                    <input type="text" name="nombre" class="form-control" 
                           pattern="^[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+(\s[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+)+$" 
                           title="Ejemplo: Mar√≠a Gonz√°lez L√≥pez" 
                           required>
                    <div class="invalid-feedback">
                        ‚ö† Formato: Nombre Apellido (M√≠nimo 2 palabras)
                    </div>
                </div>

                <!-- Direcci√≥n -->
                <div class="mb-3">
                    <label class="form-label">Direcci√≥n</label>
                    <input type="text" name="direccion" class="form-control" 
                           pattern="^C\/ [A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+(\s([A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+|[dD]e[lL]?[aA]?)?)+, N¬∫ \d+[A-Za-z]?$"  
                           required>
                    <div class="invalid-feedback">
                        ‚ö† Ejemplo: C/ Toledo, N¬∫ 27
                    </div>
                </div>
            </div>

            <!-- Columna Derecha -->
            <div class="col-md-6">
                <!-- Ciudad y C√≥digo Postal -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <label class="form-label">Ciudad</label>
                        <input type="text" name="ciudad" class="form-control" 
                               pattern="^[A-Z√Å√â√ç√ì√ö√ë][a-zA-Z√°√©√≠√≥√∫√±\s-]{2,}$" 
                               required>
                        <div class="invalid-feedback">
                            ‚ö† Ejemplo: Valdepe√±as
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">C√≥digo Postal</label>
                        <input type="text" name="codigo_postal" class="form-control" 
                               pattern="^\d{5}$" 
                               inputmode="numeric"
                               required>
                        <div class="invalid-feedback">
                            ‚ö† 5 d√≠gitos requeridos
                        </div>
                    </div>
                </div>

                <!-- Tel√©fono -->
                <div class="mb-3">
                    <label class="form-label">Tel√©fono</label>
                    <input type="tel" name="telefono" class="form-control" 
                           pattern="^(\+34|0034|34)?[6789]\d{8}$" 
                           required>
                    <div class="invalid-feedback">
                        ‚ö† Ejemplo: +34 612345678
                    </div>
                </div>
            </div>
        </div>

<!-- Correo -->

        <div class="form-group">
            <label for="correo">Correo electr√≥nico</label>
            <input type="email" name="correo" required>
        </div>


        <div class="row mt-4">
            <div class="col-12">
                <button type="submit" class="btn btn-success w-100 py-2">
                    üñ® Generar Etiqueta
                </button>
            </div>
        </div>
    </form>

    <script>
    (function () {
        'use strict'
        
        const form = document.querySelector('.needs-validation')
        
        form.addEventListener('submit', function (event) {
            event.preventDefault()
            event.stopPropagation()
            
            // Validaci√≥n mejorada
            let isValid = true
            Array.from(form.elements).forEach(element => {
                if (element.tagName === 'INPUT') {
                    if (!element.checkValidity()) {
                        element.classList.add('is-invalid')
                        element.reportValidity() // Nuevo: muestra tooltip nativo
                        isValid = false
                    } else {
                        element.classList.remove('is-invalid')
                    }
                }
            })
            
            if (!isValid) {
                form.classList.add('was-validated')
                return
            }
            
            // Solo enviar si todo es v√°lido
            this.submit()
        })
        
        // Validaci√≥n en tiempo real con debounce
        let timeout
        Array.from(form.elements).forEach(element => {
            if (element.tagName === 'INPUT') {
                element.addEventListener('input', function() {
                    clearTimeout(timeout)
                    timeout = setTimeout(() => {
                        const isValid = this.checkValidity()
                        this.classList.toggle('is-valid', isValid)
                        this.classList.toggle('is-invalid', !isValid)
                    }, 300)
                })
            }
        })
    })()
    </script>

</div>
{% endblock %}